---
import '../assets/normalize.css'
import '../assets/style.css'
import '../assets/global.css'
import { SEO } from 'astro-seo'
import { getEnv } from '../lib/env'
import backToTopIcon from '../assets/back-to-top.svg'

const { SITE_URL, RSS_URL, RSS_PREFIX } = Astro.locals
const { channel } = Astro.props

const locale = getEnv(import.meta.env, Astro, 'LOCALE')

const seo = channel?.seo
const reqPathname = Astro.url.pathname.replace(/\/$/, '')
const canonical = SITE_URL.startsWith('http') ? new URL(SITE_URL).origin + reqPathname : Astro.url.origin + reqPathname

const { origin, pathname } = new URL(canonical)
const twitter = getEnv(import.meta.env, Astro, 'TWITTER')

const seoParams = {
  title: seo?.title,
  description: seo?.text ?? channel?.description,
  canonical,
  noindex: seo?.noindex ?? getEnv(import.meta.env, Astro, 'NOINDEX'),
  nofollow: seo?.nofollow ?? getEnv(import.meta.env, Astro, 'NOFOLLOW'),
  openGraph: {
    basic: {
      type: 'website',
      title: channel?.title ?? '',
      url: canonical,
      image: channel?.avatar ? channel.avatar : origin + '/favicon.ico',
    },
    optional: {
      description: seo?.text ?? channel?.description,
      locale,
    },
  },
  extend: {
    link: [
      {
        rel: 'icon',
        href: channel?.avatar
          ? `https://wsrv.nl/?w=64&h=64&fit=cover&mask=circle&url=ssl:${channel?.avatar?.replace(/^https?:\/\//, '')}`
          : '/favicon.svg',
      },
    ],
  },
}

const GOOGLE_SEARCH_SITE = getEnv(import.meta.env, Astro, 'GOOGLE_SEARCH_SITE')
const searchAction = GOOGLE_SEARCH_SITE ? 'https://www.google.com/search' : '/search/result'

const HEADER_INJECT = getEnv(import.meta.env, Astro, 'HEADER_INJECT')
const FOOTER_INJECT = getEnv(import.meta.env, Astro, 'FOOTER_INJECT')
const TAGS = getEnv(import.meta.env, Astro, 'TAGS')
const LINKS = getEnv(import.meta.env, Astro, 'LINKS')
const navs = (getEnv(import.meta.env, Astro, 'NAVS') || '')
  .split(';')
  .filter(Boolean)
  .map((link) => {
    link = link.split(',')
    return {
      title: link[0],
      href: link[1],
    }
  })
---

<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f4f1ec" />
    <link rel="alternate" type="application/rss+xml" title={`${RSS_PREFIX}${channel?.title}`} href={RSS_URL} />
    <style is:inline>
      @view-transition {
        navigation: auto; /* enabled */
      }
    </style>
    <SEO
      titleTemplate={`%s | ${channel?.title}`}
      titleDefault={[channel?.title, seoParams.description].filter(Boolean).join(' - ')}
      twitter={{
        card: 'summary_large_image',
        creator: twitter ? `@${twitter}` : undefined,
      }}
      {...seoParams}
    />
    <Fragment set:html={HEADER_INJECT} />
  </head>

  <body>
    <div id="wrapper">
      <div id="container">
        <div id="main-container">
          <slot />
        </div>
        <div id="aside-container">
          <slot name="aside">
            <div class="nav">
              <div class="nav-item">
                <a href={SITE_URL} title={channel?.title} class={`nav-link ${pathname === '/' ? 'current' : ''}`}>
                  Home
                </a>
              </div>
              {
                TAGS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}tags`}
                      title="Tags"
                      class={`nav-link ${pathname === '/tags' ? 'current' : ''}`}
                    >
                      Tags
                    </a>
                  </div>
                ) : null
              }
              {
                LINKS ? (
                  <div class="nav-item">
                    <a
                      href={`${SITE_URL}links`}
                      title="Links"
                      class={`nav-link ${pathname === '/links' ? 'current' : ''}`}
                    >
                      Links
                    </a>
                  </div>
                ) : null
              }
              {
                navs.map((nav) => (
                  <div class="nav-item">
                    <a href={nav.href} title={nav.title} target="_blank" rel="noopener" class="nav-link">
                      {nav.title}
                    </a>
                  </div>
                ))
              }
            </div>
            <input class="search-icon" name="icon" type="checkbox" placeholder="Search" />
            <form class="search-form" action={searchAction} method="get">
              {GOOGLE_SEARCH_SITE ? <input type="hidden" name="as_sitesearch" value={GOOGLE_SEARCH_SITE} /> : null}
              <input type="text" name="q" placeholder="Search" />
            </form>
            <div class="copyright-wrap">
              Powered by
              <a
                href="https://github.com/JohnFrp/bc"
                title="BroadcastChannel"
                target="_blank"
                rel="noopener"
              >
                BroadcastChannel
              </a> &
              <a href="https://github.com/JohnFrp/bc" title="4K" target="_blank" rel="noopener">
                4K
              </a>
            </div>
          </slot>
        </div>
      </div>
    </div>
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" />
    </a>
    <Fragment set:html={FOOTER_INJECT} />
  </body>
</html>



<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <!-- ... (keep existing head content) -->
    <!-- Beautiful Header Injection -->
    <Fragment set:html={HEADER_INJECT || `
      <style>
        .header-injection {
          background: linear-gradient(135deg, #6e8efb, #a777e3);
          color: white;
          padding: 1rem;
          text-align: center;
          border-bottom: 1px solid rgba(255,255,255,0.2);
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-injection a {
          color: white;
          text-decoration: none;
          font-weight: 500;
          margin: 0 10px;
          transition: all 0.3s ease;
        }
        .header-injection a:hover {
          text-decoration: underline;
          opacity: 0.9;
        }
        .header-injection .inner {
          max-width: 1200px;
          margin: 0 auto;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 1rem;
        }
        @media (max-width: 768px) {
          .header-injection .inner {
            flex-direction: column;
          }
        }
      </style>
      <div class="header-injection">
        <div class="inner">
          <div class="brand">âœ¨ ${channel?.title || 'Your Site'}</div>
          <nav class="links">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/contact">Contact</a>
          </nav>
        </div>
      </div>
    `} />
  </head>

  <body>
    <div id="wrapper">
      <!-- ... (keep existing body content) -->
    </div>
    
    <!-- Beautiful Footer Injection -->
    <Fragment set:html={FOOTER_INJECT || `
      <style>
        .footer-injection {
          background: #2c3e50;
          color: #ecf0f1;
          padding: 2rem 1rem;
          text-align: center;
          font-size: 0.9rem;
          border-top: 1px solid rgba(255,255,255,0.1);
        }
        .footer-injection a {
          color: #3498db;
          text-decoration: none;
          transition: all 0.3s ease;
        }
        .footer-injection a:hover {
          color: #2980b9;
          text-decoration: underline;
        }
        .footer-injection .footer-content {
          max-width: 1200px;
          margin: 0 auto;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 2rem;
          text-align: left;
        }
        .footer-injection .footer-section h3 {
          color: #fff;
          margin-bottom: 1rem;
          font-size: 1.1rem;
        }
        .footer-injection .footer-section ul {
          list-style: none;
          padding: 0;
        }
        .footer-injection .footer-section li {
          margin-bottom: 0.5rem;
        }
        .footer-injection .copyright {
          margin-top: 2rem;
          padding-top: 1rem;
          border-top: 1px solid rgba(255,255,255,0.1);
        }
        @media (max-width: 768px) {
          .footer-injection .footer-content {
            grid-template-columns: 1fr;
          }
        }
      </style>
      <footer class="footer-injection">
        <div class="footer-content">
          <div class="footer-section">
            <h3>About Us</h3>
            <p>${channel?.description || 'A wonderful website built with BroadcastChannel and Astro.'}</p>
          </div>
          <div class="footer-section">
            <h3>Quick Links</h3>
            <ul>
              <li><a href="/">Home</a></li>
              <li><a href="/about">About</a></li>
              <li><a href="/contact">Contact</a></li>
              ${TAGS ? '<li><a href="/tags">Tags</a></li>' : ''}
              ${LINKS ? '<li><a href="/links">Links</a></li>' : ''}
            </ul>
          </div>
          <div class="footer-section">
            <h3>Connect</h3>
            <ul>
              ${twitter ? `<li><a href="https://twitter.com/${twitter}" target="_blank">Twitter</a></li>` : ''}
              <li><a href="${RSS_URL}" target="_blank">RSS Feed</a></li>
            </ul>
          </div>
        </div>
        <div class="copyright">
          &copy; ${new Date().getFullYear()} ${channel?.title || 'Your Site'}. All rights reserved.
        </div>
      </footer>
    `} />
    
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" />
    </a>
  </body>
</html>
